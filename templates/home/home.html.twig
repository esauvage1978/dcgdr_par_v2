{% extends 'base.html.twig' %}

{% block title %} {{ parent() }} Page d'accueil {% endblock %}

{% block body %}
    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        {% if app.user.emailvalidated == false %}
            <div class="alert alert-danger alert-dismissible mt-2">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                <h5><i class="icon fas fa-ban"></i> Adresse mail non vérifiée !</h5>
                <p>
                    Attention votre adresse mail n'a pas encore été vérifiée.
                </p>
                <p>
                    <a href="{{ path('profil_sendmail_email_validated') }}">Cliquer ici</a> pour renvoyer le lien de
                    vérification.
                </p>
            </div>
        {% endif %}

        {% if app.user.organismes | length == 0 %}
            <div class="alert alert-danger alert-dismissible mt-2">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                <h5><i class="icon fas fa-ban"></i> Aucun organisme associé à votre compte !</h5>
                <p>
                    Attention vous n'avez aucun organisme associé à votre compte.
                    Merci de contacter un gestionnaire
                </p>
                <p>
                    <a href="{{ path('contact') }}#anchor_gestionnaire">Cliquer ici</a> pour consulter la liste des
                    gestionnaires.
                </p>
            </div>
        {% endif %}

        <div class="row bg-white ">
            <div class="col-sm-4">
                <img src="{{ absolute_url( asset('img/fond_cut.png')) }}" alt="">
            </div>
            <div class="col-sm-8 pr-4 pt-5">
                <div class="text-center">
                    <h1 class="font-weight-bold">DCGDR PAR</h1>
                    <span class="text-muted">Application de gestion des plans d'actions</span>
                </div>
                <br/>
                {{ include('message/_show_messages.html.twig',{'messages':messages}) }}
                <br/>
                <div class="row justify-content-center">

                    {% for axe in axes %}
                        <div class="col-lg-4 col-md-6 col-sm-12">
                            {{ include('axe/_view/_box.html.twig',{'axe':axe }) }}
                        </div>
                    {% endfor %}
                </div>
                <div class="row justify-content-center card-deck mt-5">

                    <div class="col-lg-6 col-sm-12" id="work">
                        <div class="card card-outline card-danger bg-light  " id="div_urgent">
                            <div class="card-header text-center">
                                <h3>
                                    URGENT
                                </h3>
                            </div>
                            <div class="card-body list-group list-group-flush p-1" id="div_urgent_body">
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_without_writers',
                                        'titre':'Les actions sans pilote',
                                        'url':'my_action',
                                        'filtre':'without_writers' }) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'deployement_without_jalon',
                                        'color':'warning',
                                        'titre':'Mes deploiements sans jalon',
                                        'url':'my_deployement',
                                        'filtre':'without_jalon'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'deployement_jalon_to_late',
                                        'color':'danger',
                                        'titre':'Mes deploiements avec jalon dépassé',
                                        'url':'my_deployement',
                                        'filtre':'jalon_to_late'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_without_jalon_writer',
                                        'color':'warning',
                                        'titre':'Mes actions sans jalon en tant que pilote',
                                        'url':'my_action',
                                        'filtre':'without_jalon_writer'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_without_jalon_valider',
                                        'color':'warning',
                                        'titre':'Mes actions sans jalon en tant que valideur',
                                        'url':'my_action',
                                        'filtre':'without_jalon_valider'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_late_valider',
                                        'color':'danger',
                                        'titre':'Mes actions en tant que valideur avec jalon dépassé',
                                        'url':'my_action',
                                        'filtre':'jalon_to_late_valider'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_late_writer',
                                        'color':'danger',
                                        'titre':'Mes actions en tant que pilote avec jalon dépassé',
                                        'url':'my_action',
                                        'filtre':'jalon_to_late_writer'}) }}
                                {% if is_granted('ROLE_GESTIONNAIRE_LOCAL') %}
                                    {% for organisme in app.user.organismes %}
                                        {{ include('home/btn/_home_action.html.twig',
                                            {   'domaine':'piloteorganisme_' ~ organisme.id,
                                                'titre':'Les deploiements pour ' ~ organisme.name  ~ ' sans pilote',
                                                'url':'deployements_for_organisme_pilote',
                                                'filtre':'' ~ organisme.id}) }}
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <!-- /.card -->
                        </div>

                        <div class="card card-outline card-success  bg-light " id="div_avenir">
                            <div class="card-header text-center">
                                <h3>
                                    A VENIR
                                </h3>
                            </div>
                            <div class="card-body list-group list-group-flush p-1" id="div_avenir_body">
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'deployement_jalon_to_come_up',
                                        'titre':'Mes deploiements avec jalon > 7 jours',
                                        'url':'my_deployement',
                                        'filtre':'jalon_to_come_up'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_come_up_valider',
                                        'titre':'Mes actions en tant que valideur avec jalon > 7 jours',
                                        'url':'my_action',
                                        'filtre':'jalon_to_come_up_valider'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_come_up_writer',
                                        'titre':'Mes actions en tant que pilote avec jalon > 7 jours',
                                        'url':'my_action',
                                        'filtre':'jalon_to_come_up_writer'}) }}
                            </div>

                            <!-- /.card -->
                        </div>
                        <div class="card-body">
                            {{ include('home/btn/_home_action_link.html.twig',
                                {   'domaine':'deployementterminated',
                                    'titre':'Mes deploiements terminés',
                                    'url':'my_deployement',
                                    'filtre':'allterminated'}) }}
                        </div>

                    </div>
                    <div class="col-lg-6 col-sm-12 ">
                        <div class="card card-outline card-warning  bg-light " id="div_encours">
                            <div class="card-header text-center">
                                <h3>
                                    EN COURS
                                </h3>
                            </div>
                            <div class="card-body list-group list-group-flush p-1" id="div_encours_body">
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'deployement',
                                        'titre':'Mes deploiements',
                                        'url':'my_deployement',
                                        'filtre':'all'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'deployement_jalon_to_near',
                                        'color':'warning',
                                        'titre':'Mes deploiements avec jalon <=7 jours',
                                        'url':'my_deployement',
                                        'filtre':'jalon_to_near'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_near_valider',
                                        'color':'warning',
                                        'titre':'Mes actions en tant que valideur avec jalon <=7 jours',
                                        'url':'my_action',
                                        'filtre':'jalon_to_near_valider'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_jalon_to_near_writer',
                                        'color':'warning',
                                        'titre':'Mes actions en tant que pilote avec jalon <=7 jours',
                                        'url':'my_action',
                                        'filtre':'jalon_to_near_writer'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_valider_cotech',
                                        'titre':'Mes actions à traiter lors du COTECH',
                                        'url':'my_action',
                                        'filtre':'valider_cotech'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_valider_codir',
                                        'titre':'Mes actions à traiter lors du CODIR',
                                        'url':'my_action',
                                        'filtre':'valider_codir'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_started',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'started'}),
                                        'url':'my_action',
                                        'filtre':'started'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_finalised',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'finalised'}),
                                        'url':'my_action',
                                        'filtre':'finalised'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_measured',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'measured'}),
                                        'url':'my_action',
                                        'filtre':'measured'}) }}

                            </div>
                            <!-- /.card -->
                        </div>

                        <div class="card card-outline card-primary  bg-light " id="div_supervision">
                            <div class="card-header text-center">
                                <h3>
                                    SUPERVISION
                                </h3>
                            </div>
                            <div class="card-body list-group list-group-flush p-1" id="div_supervision_body">
                                {% if is_granted('ROLE_GESTIONNAIRE_LOCAL') %}
                                    {% for organisme in app.user.organismes %}
                                        {{ include('home/btn/_home_action.html.twig',
                                            {   'domaine':'organisme_' ~ organisme.id,
                                                'titre':'Les deploiements pour ' ~ organisme.name,
                                                'url':'deployements_for_organisme',
                                                'filtre':'' ~ organisme.id}) }}
                                    {% endfor %}
                                {% endif %}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action',
                                        'titre':'Mes actions en tant que pilote',
                                        'url':'my_action',
                                        'filtre':'all'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_cotech',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'cotech'}),
                                        'url':'my_action',
                                        'filtre':'cotech'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_codir',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'codir'}),
                                        'url':'my_action',
                                        'filtre':'codir'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_rejected',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'rejected'}),
                                        'url':'my_action',
                                        'filtre':'rejected'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_deployed',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'deployed'}),
                                        'url':'my_action',
                                        'filtre':'deployed'}) }}
                                {{ include('home/btn/_home_action.html.twig',
                                    {   'domaine':'action_clotured',
                                        'color':'info',
                                        'titre':'Mes actions dans l\'état ' ~ include('workflow/_state.html.twig',{'state':'clotured'}),
                                        'url':'my_action',
                                        'filtre':'clotured'}) }}
                            </div>
                            <!-- /.card -->
                        </div>
                    </div>


                </div>
            </div>
        </div>
    {% else %}
        <div class="row bg-white shadow ">
            <div class="col-sm-4 ">
                <img src="{{ absolute_url( asset('img/closed.png')) }}"
                     style="min-width:50%;
                        min-height:50%;
                        width:auto;
                        height:auto;" alt="nothing"/>
            </div>
            <div class="col-sm-8 pr-4 pt-5">
                <div class="row justify-content-center ">
                    <h1 class="font-weight-bold  bg-white rounded"><b>DCGDR</b> PAR</h1>
                </div>
                <div class="row justify-content-center ">

                    <span class="text-muted  bg-white rounded">Gestion des plans d'actions de la DCGDR</span>
                </div>
                <br/>

                <div class="row justify-content-center">
                    <div class="col-6 m-5 bg-white rounded">
                        <h3><i class="fa fa-lock fa-fw text-danger"></i> Oops! Vous n'êtes pas connecté.</h3>

                        <p>
                            <br/><br/>
                            Rien de grave, vous pouvez <a href="{{ path('user_login') }}"> le faire à partir de la page
                                de
                                connexion</a>.
                        </p>
                        <p>
                            A tout de suite !
                        </p>

                    </div>

                </div>
            </div>
        </div>

    {% endif %}







{% endblock %}


{% block javascripts %}
    <script src="{{ absolute_url( asset('js/message/show.js')) }}"></script>
    <script src="{{ absolute_url( asset('js/home_action.js')) }}"></script>
    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        <script>
            $(function () {

                {% for axe in axes %}
                searchCountAxe('{{ axe.id }}', '{{ absolute_url(path('ajax_action_for_axe_count')) }}');
                {% endfor %}

                // URGENT
                {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_GESTIONNAIRE') %}
                searchCount('action_without_writers', '{{ absolute_url(path('ajax_my_action_count')) }}', 'without_writers');
                {% endif %}
                searchCount('deployement_without_jalon', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'without_jalon');
                searchCount('deployement_jalon_to_late', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'jalon_to_late');
                searchCount('action_without_jalon_writer', '{{ path('ajax_my_action_count') }}', 'without_jalon_writer');
                searchCount('action_without_jalon_valider', '{{ path('ajax_my_action_count') }}', 'without_jalon_valider');
                searchCount('action_jalon_to_late_writer', '{{ path('ajax_my_action_count') }}', 'jalon_to_late_writer');
                searchCount('action_jalon_to_late_valider', '{{ path('ajax_my_action_count') }}', 'jalon_to_late_valider');
                {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_GESTIONNAIRE_LOCAL') %}
                {% for organisme in app.user.organismes %}
                searchCount('piloteorganisme_{{ organisme.id }}', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'piloteorganisme_{{ organisme.id }}');
                {% endfor %}
                {% endif %}

                //EN COURS
                searchCount('deployementterminated', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'allterminated');
                searchCount('deployement', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'all');
                searchCount('deployement_jalon_to_near', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'jalon_to_near');
                searchCount('action_jalon_to_near_writer', '{{ path('ajax_my_action_count') }}', 'jalon_to_near_writer');
                searchCount('action_jalon_to_near_valider', '{{ path('ajax_my_action_count') }}', 'jalon_to_near_valider');
                searchCount('action_started', '{{ path('ajax_my_action_count') }}', 'started');
                searchCount('action_finalised', '{{ path('ajax_my_action_count') }}', 'finalised');
                searchCount('action_measured', '{{ path('ajax_my_action_count') }}', 'measured');
                searchCount('action_valider_cotech', '{{ path('ajax_my_action_count') }}', 'valider_cotech');
                searchCount('action_valider_codir', '{{ path('ajax_my_action_count') }}', 'valider_codir');

                //A SUPERVISER
                {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_GESTIONNAIRE_LOCAL') %}
                {% for organisme in app.user.organismes %}
                searchCount('organisme_{{ organisme.id }}', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'organisme_{{ organisme.id }}');
                {% endfor %}
                {% endif %}
                searchCount('action', '{{ path('ajax_my_action_count') }}', 'all');
                searchCount('action_cotech', '{{ path('ajax_my_action_count') }}', 'cotech');
                searchCount('action_rejected', '{{ path('ajax_my_action_count') }}', 'rejected');
                searchCount('action_codir', '{{ path('ajax_my_action_count') }}', 'codir');
                searchCount('action_deployed', '{{ path('ajax_my_action_count') }}', 'deployed');
                searchCount('action_clotured', '{{ path('ajax_my_action_count') }}', 'clotured');


                //A VENIR
                searchCount('deployement_jalon_to_come_up', '{{ absolute_url(path('ajax_my_deployement_count')) }}', 'jalon_to_come_up');
                searchCount('action_jalon_to_come_up_valider', '{{ path('ajax_my_action_count') }}', 'jalon_to_come_up_valider');
                searchCount('action_jalon_to_come_up_writer', '{{ path('ajax_my_action_count') }}', 'jalon_to_come_up_writer');

            });
        </script>
    {% endif %}
{% endblock %}